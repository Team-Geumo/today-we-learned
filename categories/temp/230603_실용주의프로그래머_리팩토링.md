### Topic 40. 리팩터링 (오타 아님)

- 프로그램이 발전함에 따라 점점 초기에 내린 결정을 다시 고려하고 코드의 일부분을 다시 작성할 일이 생긴다.

- 안타깝게도 소프트웨어 개발의 배유로 가장 널리 쓰이는 메타포는 건축이다.

  - 건축의 메타포는 다음 단계를 거친다.

    1. 건축가가 설계도를 그린다.

    2. 건축업자는 땅에 기초를 놓고, 상부 구조를 세우고, 전선과 배관을 잇고, 최종 마무리를 한다.

    3. 입주민들이 건물에 이사 와서 행복하게 산다. 문제가 생기면 건물 관리실에 고쳐 달라고 연락한다.

<br/>

- **소프트웨어는 이런 식으로 돌아가지 않는다.**

<br/>

- `실용주의 프로그래머`에서는 소프트웨어 개발은 건축보다 **정원 가꾸기**에 더 가깝다고 비유한다.

- 프로그래밍이 딱딱한 것이 아니라 유기적인 활동이라고 보기 때문이다.

  - 정원의 메타포는 다음 단계를 거친다.

    1. 최초 계획과 조건에 맞추어 여러 가지 식물을 심는다.
    - 몇몇은 잘 자라겠지만 몇몇은 퇴비가 될 운명.
    2. 빛과 그림자, 비와 바람의 상호 작용을 더 잘 이용하기 위해 식물들의 상대적인 위치를 옮기기도 한다.
    3. 너무 많이 자란 식물은 포기를 나누거나 가지치기를 한다.
    4. 식물의 색이 서로 충돌하면 더 아름답게 보이도록 위치를 바꾸기도 한다.
    5. 정원의 건강 상태를 지속적으로 관찰하며, 필요하면 토양, 식물, 정원 배치를 조정한다.
<br/>

  - 어떤 루틴이 너무 크게 자라거나 너무 많은 것을 하려고 할지도 모른다. 그러면 둘로 나눠야한다.

  - 계획한 대로 잘 되지 않는 것들은 잡초 제거하듯 뽑아내거나 가지치기를 해야한다.

  <br/>

  - 마틴 파울러의 `리팩터링`에서 리팩터링을 다음과 같이 정의한다.

    ```text
    밖으로 드러나는 동작은 그대로 유지한 채 
    내부 구조를 변경함으로써 이미 존재하는 코드를 재구성하는 체계적 기법.
    ```

  - 이 정의의 핵심은 두가지이다.

    1. 이 활동은 체계적이다. 아무렇게나 하는 것이 아니다.

    2. 밖으로 드러나는 동작은 바뀌지 않는다. 기능을 추가하는 작업이 아니다.
  <br/>

- 식물을 다시 심기 위해 **정원 전체를 갈아엎듯이 해서는 안 된다.** 특별하고 격식을 갖추어야 하는 활동, 가뭄에 콩 나듯 드물게 하는 활동이어서는 안 된다는 것.

- 리팩터링은 그런 것이 아니라 `잡초 제거`나 `갈퀴질`처럼 위험하지 않은 작은 단계들을 밟는 **일상 활동**이다.

<br/>
<br/>

#### 리팩터링은 언제 하는가?

- 무언가를 알게 되었을 때. 작년이나 어제, 심지어 10분 전과 비교해서 더 많이 알게 되었다면, 리팩터링을 한다.

- 어떤 부분이 잘못 되었다는 생각이 든다면 주저하지 말고 리팩터링을 하라.

  - 중복

    - DRY 원칙 위반을 발견했다.

  - 직교적이지 않은 설계

    - 더 직교적으로 바꿀 수 있는 무언가를 발견했다.

  - 더 이상 유효하지 않은 지식

    - 사물은 변하고, 요구 사항은 변경되며, 지금 처리하고 있는 문제에 대한 지식은 늘어난다. 코드는 지금 상황에 뒤떨어지지 않아야한다.

  - 사용 사례

   - 진짜 사람들이 실제 상황에서 시스템을 사용하게 되면, 여러분은 어떤 기능은 예전에 생각했던 것보다 더 중요하고, '꼭 필요하다'고 생각했던 기능은 그렇지 않은 경우도 있다는 것을 깨닫게 될 것이다.

  - 성능

    - 성능을 개선하려면 시스템의 한 영역에서 다른 영역으로 기능을 옮겨야 한다.

  - 테스트 통과

    - 리팩터링은 작은 규모의 활동이고, 좋은 테스트가 뒷받침되어야 한다. 그러니 코드를 조금 추가한 후 추가한 테스트가 통과했을 때, 방금 추가한 코드라 다시 뛰어들어 깜끔하게 정리하기에 최고의 타이밍이다.

<br/>

- 리팩터링이 필요한 코드를 일종의 '종양'이라고 생각하라.

  - 종양을 제거하려면 수술이 필요하다.

  - 지금 바로 수술해서 아직 종양이 작을 때 제거할 수도 있다.

  - 아니면 종양이 자라고 다른 곳으로 전이할 때까지 놓아둘 수도 있다.

  - 하지만 나중에 제거하려면 드는 비용도 더 늘어나며 위험도 훨씬 커진다.

  - 시간을 더 끌다간 환자는 생명을 잃을 지도 모른다.

<br/>

#### 리팩터링은 어떻게 하는가?

- 리팩터링의 본질은 재설계다.

- 새로운 사실이 밝혀지거나, 문제에 대한 이해가 더 깊어지거나, 요구 사항이 바뀐다면 언제라도 재설계의 대상이 될 수 있다.

- 마틴 파울러의 `리팩터링`에서 나온 몇 가지 리팩터링에 대한 조언

  1. 리팩터링과 기능 추가를 동시에 하지 말라.

  2. 리팩터링을 시작하기 전 든든한 테스트가 있는지 먼저 확이하라. 할 수 있는 한 자주 테스트를 돌려보라. 이렇게 하면 여러분이 바꾼 것 때문에 무언가 망가졌을 경우 그 사실을 재빨리 알 수 있다.

  3. 단계를 작게 나누어서 신중하게 작업하라. 클래스의 필드 하나를 다른 클래스로 옮기기, 매서드 하나 쪼개기, 변수명 하나 바꾸기 같이 작은 단위로 작업해야 한다. 리팩터링에서는 국지적인 변경들이 많이 모여서 커다란 규모의 변화를 낳는 일이 자주 발생한다. 단계를 작게 나누고, 한 단계가 끝날 때마다 테스트를 돌린다면 기나긴 디버깅 작업을 피할 수 있다.

<br/>

- 리팩토링은 고통 관리이다. 코딩을 하며 그 자리에서 내 코드에 문제가 있다는 사실을 인정하기 쉽지 않더라도 즉시 처리해내지 않으면 나중에는 더 큰 고통으로 돌아올 것이다. 괴롭겠지만 나중을 위해서라도 빠르게 리팩토링을 하는 것이 좋은 방법이다.